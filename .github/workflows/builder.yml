name: Build node-llama-cpp addons
on:
  workflow_dispatch:
  push:
    branches: [ builder ]
jobs:
  windows-cuda:
    runs-on: windows-2019
    strategy:
      matrix:
        cuda_version: ['11.8.0', '12.4.1', '12.2.0']
        include:
          - cuda_version: '11.8.0'
            optimized: 'windows-cuda-1180'
          - cuda_version: '12.4.1'
            optimized: 'windows-cuda-1241'
          - cuda_version: '12.2.0'
            optimized: 'windows-cuda-1220'
    outputs:
      llama-tag: ${{ steps.extract-tag.outputs.tag }}
    steps:
      - name: Clone node-llama-cpp repository
        uses: actions/checkout@v4
        with:
          repository: RaimundoLai/node-llama-cpp
          branch: master
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          
      - name: Add msbuild to PATH
        uses: microsoft/setup-msbuild@v2
        
      - name: Install dependencies
        run: |
          choco install cmake -y
          npm install -g cmake-js
          
      - name: Install CUDA Toolkit
        uses: Jimver/cuda-toolkit@v0.2.22
        id: cuda-toolkit
        with:
          cuda: ${{ matrix.cuda_version }}
          method: 'network'
          sub-packages: '["nvcc", "cudart", "cublas", "cublas_dev", "thrust", "visual_studio_integration"]'
          
      - name: Build
        shell: powershell
        run: |
          npm ci
          npm run build
          node ./dist/cli/cli.js source download --release latest --skipBuild --noBundle --noUsageExample --updateBinariesReleaseMetadataAndSaveGitBundle
          node ./dist/cli/cli.js source build --ciMode --noUsageExample --arch x64 --nodeTarget 20 --gpu cuda
          
      - name: Find build directory and package
        shell: powershell
        run: |
          $buildDir = Get-ChildItem -Path "./llama/localBuilds" -Directory | Where-Object { $_.Name -like "win-x64-release-*" } | Select-Object -First 1
          
          if ($null -eq $buildDir) {
            Write-Error "Build directory not found"
            exit 1
          }
          
          Write-Host "Found build directory: $($buildDir.Name)"
          
          echo "BUILD_DIR_NAME=$($buildDir.Name)" >> $env:GITHUB_ENV
          echo "RELEASE_PATH=$($buildDir.FullName)/Release" >> $env:GITHUB_ENV
          
          $releasePath = Join-Path $buildDir.FullName "Release"
          if (!(Test-Path $releasePath)) {
            Write-Error "Release directory not found at: $releasePath"
            exit 1
          }
          
          Write-Host "Release directory confirmed at: $releasePath"
          
      - name: Extract llama.cpp tag from build directory
        id: extract-tag
        shell: powershell
        run: |
          $buildDirName = $env:BUILD_DIR_NAME
          $tag = $buildDirName -replace "win-x64-release-", ""
          
          Write-Host "Extracted llama.cpp tag: $tag"
          echo "tag=$tag" >> $env:GITHUB_OUTPUT
          echo "LLAMA_TAG=$tag" >> $env:GITHUB_ENV
          
      - name: Create tar.gz archive
        shell: powershell
        run: |
          choco install 7zip -y
          
          $archiveName = "${{ matrix.optimized }}.tar.gz"
          $releasePath = $env:RELEASE_PATH
          
          Write-Host "Creating archive: $archiveName"
          Write-Host "From directory: $releasePath"
          
          Push-Location $releasePath
          
          try {
            & "C:\Program Files\7-Zip\7z.exe" a -ttar temp.tar *
            if ($LASTEXITCODE -ne 0) {
              Write-Error "Failed to create tar file"
              exit 1
            }
            
            & "C:\Program Files\7-Zip\7z.exe" a -tgzip "$archiveName" temp.tar
            if ($LASTEXITCODE -ne 0) {
              Write-Error "Failed to create gzip file"
              exit 1
            }
            
            Move-Item $archiveName $env:GITHUB_WORKSPACE\
            
            Remove-Item temp.tar -ErrorAction SilentlyContinue
            
          } finally {
            Pop-Location
          }
          
          Write-Host "Archive created successfully: $archiveName"
          echo "ARCHIVE_NAME=$archiveName" >> $env:GITHUB_ENV
          
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.optimized }}
          path: ${{ env.ARCHIVE_NAME }}
          
  windows-no-cuda:
    runs-on: windows-2019
    outputs:
      llama-tag: ${{ steps.extract-tag.outputs.tag }}
    steps:
      - name: Clone node-llama-cpp repository
        uses: actions/checkout@v4
        with:
          repository: RaimundoLai/node-llama-cpp
          branch: master
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          
      - name: Add msbuild to PATH
        uses: microsoft/setup-msbuild@v2
          
      - name: Install dependencies
        run: |
          choco install cmake -y
          npm install -g cmake-js

      - name: Build
        shell: powershell
        run: |
          npm ci
          npm run build
          node ./dist/cli/cli.js source download --release latest --skipBuild --noBundle --noUsageExample --updateBinariesReleaseMetadataAndSaveGitBundle
          node ./dist/cli/cli.js source build --ciMode --noUsageExample --arch x64 --nodeTarget 20 --gpu false
          
      - name: Find build directory and package
        shell: powershell
        run: |
          $buildDir = Get-ChildItem -Path "./llama/localBuilds" -Directory | Where-Object { $_.Name -like "win-x64-release-*" } | Select-Object -First 1
          
          if ($null -eq $buildDir) {
            Write-Error "Build directory not found"
            exit 1
          }
          
          Write-Host "Found build directory: $($buildDir.Name)"
          
          echo "BUILD_DIR_NAME=$($buildDir.Name)" >> $env:GITHUB_ENV
          echo "RELEASE_PATH=$($buildDir.FullName)/Release" >> $env:GITHUB_ENV
          
          $releasePath = Join-Path $buildDir.FullName "Release"
          if (!(Test-Path $releasePath)) {
            Write-Error "Release directory not found at: $releasePath"
            exit 1
          }
          
          Write-Host "Release directory confirmed at: $releasePath"
          
      - name: Extract llama.cpp tag from build directory
        id: extract-tag
        shell: powershell
        run: |
          $buildDirName = $env:BUILD_DIR_NAME
          $tag = $buildDirName -replace "win-x64-release-", ""
          
          Write-Host "Extracted llama.cpp tag: $tag"
          echo "tag=$tag" >> $env:GITHUB_OUTPUT
          echo "LLAMA_TAG=$tag" >> $env:GITHUB_ENV
          
      - name: Create tar.gz archive
        shell: powershell
        run: |
          choco install 7zip -y
          
          $archiveName = "windows-no-cuda.tar.gz"
          $releasePath = $env:RELEASE_PATH
          
          Write-Host "Creating archive: $archiveName"
          Write-Host "From directory: $releasePath"
          
          Push-Location $releasePath
          
          try {
            & "C:\Program Files\7-Zip\7z.exe" a -ttar temp.tar *
            if ($LASTEXITCODE -ne 0) {
              Write-Error "Failed to create tar file"
              exit 1
            }
            
            & "C:\Program Files\7-Zip\7z.exe" a -tgzip "$archiveName" temp.tar
            if ($LASTEXITCODE -ne 0) {
              Write-Error "Failed to create gzip file"
              exit 1
            }
            
            Move-Item $archiveName $env:GITHUB_WORKSPACE\
            
            Remove-Item temp.tar -ErrorAction SilentlyContinue
            
          } finally {
            Pop-Location
          }
          
          Write-Host "Archive created successfully: $archiveName"
          echo "ARCHIVE_NAME=$archiveName" >> $env:GITHUB_ENV
          
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-no-cuda
          path: ${{ env.ARCHIVE_NAME }}

  create-update-release:
    needs: [windows-cuda, windows-no-cuda]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          
      - name: List artifacts
        run: ls -R artifacts/
        
      - name: Get llama.cpp tag
        id: llama-tag
        run: |
          # 從 windows-cuda job 獲取 llama tag（所有 job 應該使用相同版本）
          LLAMA_TAG="${{ needs.windows-cuda.outputs.llama-tag }}"
          echo "Using llama.cpp tag: $LLAMA_TAG"
          echo "tag=$LLAMA_TAG" >> $GITHUB_OUTPUT
          
      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT
        
      - name: Create llama.cpp Tagged Release
        uses: softprops/action-gh-release@v1
        if: github.event_name != 'pull_request'
        with:
          tag_name: llama-${{ steps.llama-tag.outputs.tag }}
          name: node-llama-cpp builds (llama.cpp ${{ steps.llama-tag.outputs.tag }})
          body: |
            node-llama-cpp addon builds based on llama.cpp ${{ steps.llama-tag.outputs.tag }}
            Build date: ${{ steps.date.outputs.date }}
            
            **Available builds:**
            - Windows with CUDA 11.8.0 support
            - Windows with CUDA 12.2.0 support  
            - Windows with CUDA 12.4.1 support
            - Windows without CUDA support
            
            **Installation:**
            Extract the tar.gz file to your node-llama-cpp installation directory.
          files: |
            artifacts/**/*.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Update Latest Release
        uses: softprops/action-gh-release@v1
        if: github.event_name != 'pull_request'
        with:
          tag_name: latest
          name: Latest node-llama-cpp builds
          body: |
            Latest node-llama-cpp addon builds.
            Based on llama.cpp: ${{ steps.llama-tag.outputs.tag }}
            Last updated: ${{ steps.date.outputs.date }}
            
            **Available builds:**
            - Windows with CUDA 11.8.0 support
            - Windows with CUDA 12.2.0 support
            - Windows with CUDA 12.4.1 support  
            - Windows without CUDA support
            
            **Installation:**
            Extract the tar.gz file to your node-llama-cpp installation directory.
          files: |
            artifacts/**/*.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}